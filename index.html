<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Connection Checker</title>
  <script src="./lib/react.production.min.js"></script>
  <script src="./lib/react-dom.production.min.js"></script>
  <script src="./lib/babel.min.js"></script>
  <script src="./lib/i18next.min.js"></script>
  <script src="./lib/axios.min.js"></script>
  <style>
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      transition: background 0.2s, color 0.2s;
    }
    body.light { 
      background: #fff !important; 
      color: #000; 
    }
    body.dark { 
      background: #1e1e1e !important; 
      color: #fff; 
    }
    #root { 
      display: flex; 
      flex-direction: column; 
      min-height: 100vh; 
      padding: 1.25rem; 
    }
    h1 { 
      font-size: 1.5rem; 
      margin-bottom: 1.25rem; 
    }
    .tabs { 
      display: flex; 
      border-bottom: 1px solid #ccc; 
      margin-bottom: 1.25rem; 
    }
    .dark .tabs { 
      border-bottom-color: #555; 
    }
    .tab { 
      padding: 0.625rem 1.25rem; 
      cursor: pointer; 
      border-bottom: 2px solid transparent; 
    }
    .tab.active { 
      border-bottom: 2px solid #1976d2; 
      font-weight: bold; 
    }
    .dark .tab.active { 
      border-bottom-color: #90caf9; 
    }
    .config { 
      margin-bottom: 1.25rem; 
    }
    .form-group { 
      margin-bottom: 0.9375rem; 
    }
    label { 
      display: block; 
      margin-bottom: 0.3125rem; 
      font-weight: bold; 
    }
    select, input[type="text"], input[type="number"] { 
      width: 100%; 
      padding: 0.5rem; 
      border: 1px solid #ccc; 
      border-radius: 0.25rem; 
      box-sizing: border-box; 
      background: #fff; 
      color: #000; 
    }
    .dark select, .dark input[type="text"], .dark input[type="number"] { 
      background: #333; 
      color: #fff; 
      border-color: #555; 
    }
    select[multiple] { 
      height: 12.5rem; 
    }
    button { 
      padding: 0.625rem 1.25rem; 
      background: #1976d2; 
      color: #fff; 
      border: none; 
      border-radius: 0.25rem; 
      cursor: pointer; 
    }
    .dark button { 
      background: #90caf9; 
      color: #000; 
    }
    button:disabled { 
      background: #aaa; 
    }
    button:hover:not(:disabled) { 
      background: #1565c0; 
    }
    .dark button:hover:not(:disabled) { 
      background: #64b5f6; 
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 0.625rem; 
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 0.5rem; 
      text-align: left; 
    }
    .dark th, .dark td { 
      border-color: #555; 
    }
    tr.risky { 
      background: #ffccbc; 
    }
    .dark tr.risky { 
      background: #ff8a65; 
    }
    .alert { 
      color: #d32f2f; 
      font-weight: bold; 
    }
    .spinner { 
      display: inline-block; 
      width: 1.5rem; 
      height: 1.5rem; 
      border: 3px solid #fff; 
      border-top-color: #1976d2; 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    @keyframes spin { 
      to { transform: rotate(360deg); } 
    }
  </style>
</head>
<body class="light">
  <div id="root"></div>
  <script type="text/babel">
    window.$RefreshReg$ = () => {};
    window.$RefreshSig$ = () => () => {};

    const { useState, useEffect } = React;
    const { ipcRenderer } = window.electron;

    const countries = ['Algeria', 'Australia', 'Austria', 'Bangladesh', 'Belarus', 'Belgium', 'Canada', 'China', 'Denmark', 'Egypt', 'Finland', 'France', 'Germany', 'Ghana', 'Greece', 'Honduras', 'India', 'Iran', 'Ireland', 'Israel', 'Italy', 'Japan', 'Kenya', 'Morocco', 'Netherlands', 'New Zealand', 'Nigeria', 'Norway', 'Panama', 'Russia', 'Singapore', 'South Africa', 'South Korea', 'Spain', 'Sweden', 'Switzerland', 'Thailand', 'Ukraine', 'United Kingdom', 'United States', 'Venezuela'].sort();

    i18next.init({
      lng: 'en',
      resources: {
        en: { translation: { appTitle: 'Network Connection Checker', check: 'Check Now', interval: 'Check Interval (min)', periodic: 'Enable Periodic Checks', countriesFriendly: 'Friendly Countries', countriesRisky: 'Risky Countries', bannedIPs: 'Banned IPs', riskyProviders: 'Risky Providers', connectionsByCountry: 'Connections by Country', darkMode: 'Dark Mode', loading: 'Checking...', noConnections: 'No active connections found.', riskyConnection: 'Risky connection!' } },
        fr: { translation: { appTitle: 'Vérificateur de Connexions Réseau', check: 'Vérifier Maintenant', interval: 'Intervalle de Vérification (min)', periodic: 'Activer les Vérifications Périodiques', countriesFriendly: 'Pays Amis', countriesRisky: 'Pays Risqués', bannedIPs: 'IPs Bannies', riskyProviders: 'Fournisseurs Risqués', connectionsByCountry: 'Connexions par Pays', darkMode: 'Mode Sombre', loading: 'Vérification en cours...', noConnections: 'Aucune connexion active trouvée.', riskyConnection: 'Connexion risquée !' } },
        it: { translation: { appTitle: 'Controllore Connessioni di Rete', check: 'Controlla Ora', interval: 'Intervallo di Controllo (min)', periodic: 'Abilita Controlli Periodici', countriesFriendly: 'Paesi Amici', countriesRisky: 'Paesi Rischiosi', bannedIPs: 'IP Bloccati', riskyProviders: 'Fornitori Rischiosi', connectionsByCountry: 'Connessioni per Paese', darkMode: 'Modalità Scura', loading: 'Controllo in corso...', noConnections: 'Nessuna connessione attiva trovata.', riskyConnection: 'Connessione rischiosa!' } },
        de: { translation: { appTitle: 'Netzwerkverbindungsprüfer', check: 'Jetzt Prüfen', interval: 'Prüfintervall (min)', periodic: 'Periodische Prüfungen Aktivieren', countriesFriendly: 'Freundliche Länder', countriesRisky: 'Riskante Länder', bannedIPs: 'Gesperrte IPs', riskyProviders: 'Riskante Anbieter', connectionsByCountry: 'Verbindungen nach Land', darkMode: 'Dunkler Modus', loading: 'Prüfe...', noConnections: 'Keine aktiven Verbindungen gefunden.', riskyConnection: 'Riskante Verbindung!' } },
        es: { translation: { appTitle: 'Verificador de Conexiones de Red', check: 'Verificar Ahora', interval: 'Intervalo de Verificación (min)', periodic: 'Activar Verificaciones Periódicas', countriesFriendly: 'Países Amigos', countriesRisky: 'Países Riesgosos', bannedIPs: 'IPs Prohibidas', riskyProviders: 'Proveedores Riesgosos', connectionsByCountry: 'Conexiones por País', darkMode: 'Modo Oscuro', loading: 'Verificando...', noConnections: 'No se encontraron conexiones activas.', riskyConnection: '¡Conexión arriesgada!' } },
        el: { translation: { appTitle: 'Έλεγχος Συνδέσεων Δικτύου', check: 'Έλεγχος Τώρα', interval: 'Διάστημα Ελέγχου (min)', periodic: 'Ενεργοποίηση Περιοδικών Ελέγχων', countriesFriendly: 'Φιλικές Χώρες', countriesRisky: 'Επικίνδυνες Χώρες', bannedIPs: 'Απαγορευμένες IPs', riskyProviders: 'Επικίνδυνοι Πάροχοι', connectionsByCountry: 'Συνδέσεις ανά Χώρα', darkMode: 'Σκοτεινή Λειτουργία', loading: 'Έλεγχος σε εξέλιξη...', noConnections: 'Δεν βρέθηκαν ενεργές συνδέσεις.', riskyConnection: 'Επικίνδυνη σύνδεση!' } },
        ru: { translation: { appTitle: 'Проверка сетевых соединений', check: 'Проверить сейчас', interval: 'Интервал проверки (мин)', periodic: 'Включить периодические проверки', countriesFriendly: 'Дружественные страны', countriesRisky: 'Рискованные страны', bannedIPs: 'Заблокированные IP', riskyProviders: 'Рискованные провайдеры', connectionsByCountry: 'Соединения по странам', darkMode: 'Тёмный режим', loading: 'Проверка...', noConnections: 'Активные соединения не найдены.', riskyConnection: 'Рискованное соединение!' } },
        zh: { translation: { appTitle: '网络连接检查器', check: '立即检查', interval: '检查间隔（分钟）', periodic: '启用定期检查', countriesFriendly: '友好国家', countriesRisky: '风险国家', bannedIPs: '禁止的IP', riskyProviders: '风险提供商', connectionsByCountry: '按国家分类的连接', darkMode: '暗模式', loading: '正在检查...', noConnections: '未找到活动连接。', riskyConnection: '风险连接！' } },
        ko: { translation: { appTitle: '네트워크 연결 확인기', check: '지금 확인', interval: '확인 간격 (분)', periodic: '주기적 확인 활성화', countriesFriendly: '친화적 국가', countriesRisky: '위험한 국가', bannedIPs: '차단된 IP', riskyProviders: '위험한 제공업체', connectionsByCountry: '국가별 연결', darkMode: '다크 모드', loading: '확인 중...', noConnections: '활성 연결이 없습니다.', riskyConnection: '위험한 연결!' } },
      }
    });

    const App = () => {
      const [connections, setConnections] = useState([]);
      const [friendlyCountries, setFriendlyCountries] = useState(['France', 'United States']);
      const [riskyCountries, setRiskyCountries] = useState(['Iran', 'Bangladesh', 'Venezuela', 'Honduras', 'Algeria', 'Nigeria', 'India', 'Panama', 'Thailand', 'Belarus', 'Ukraine', 'Kenya', 'South Africa', 'Ghana']);
      const [bannedIPs, setBannedIPs] = useState([]);
      const [riskyProviders, setRiskyProviders] = useState(['Choopa', 'LeaseWeb', 'QuadraNet', 'Ecatel', 'Sharktech', 'HostSailor', 'M247', 'WorldStream']);
      const [intervalMin, setIntervalMin] = useState(30);
      const [isDarkMode, setIsDarkMode] = useState(false);
      const [isScanning, setIsScanning] = useState(false);
      const [language, setLanguage] = useState('en');
      const [periodicScan, setPeriodicScan] = useState(true);
      const [activeTab, setActiveTab] = useState('main');
      const [configLoaded, setConfigLoaded] = useState(false);

      useEffect(() => {
        async function loadConfig() {
          try {
            const config = await ipcRenderer.invoke('load-config');
            if (config) {
              setFriendlyCountries(config.friendlyCountries || ['France', 'United States']);
              setRiskyCountries(config.riskyCountries || ['Iran', 'Bangladesh', 'Venezuela', 'Honduras', 'Algeria', 'Nigeria', 'India', 'Panama', 'Thailand', 'Belarus', 'Ukraine', 'Kenya', 'South Africa', 'Ghana']);
              setBannedIPs(config.bannedIPs || []);
              setRiskyProviders(config.riskyProviders || ['Choopa', 'LeaseWeb', 'QuadraNet', 'Ecatel', 'Sharktech', 'HostSailor', 'M247', 'WorldStream']);
              setIntervalMin(config.intervalMin || 30);
              setIsDarkMode(!!config.isDarkMode);
              setLanguage(config.language || 'en');
              setPeriodicScan(config.periodicScan !== false);
              i18next.changeLanguage(config.language || 'en');
              setConfigLoaded(true);
            }
          } catch (error) {
            console.error('Failed to load config:', error);
          }
        }
        loadConfig();
      }, []);

      useEffect(() => {
        document.body.className = isDarkMode ? 'dark' : 'light';
      }, [isDarkMode]);

      useEffect(() => {
        if (!configLoaded) return;
        async function saveConfig() {
          try {
            await ipcRenderer.invoke('save-config', {
              friendlyCountries, riskyCountries, bannedIPs, riskyProviders, intervalMin, isDarkMode, language, periodicScan
            });
          } catch (error) {
            console.error('Failed to save config:', error);
          }
        }
        saveConfig();
      }, [friendlyCountries, riskyCountries, bannedIPs, riskyProviders, intervalMin, isDarkMode, language, periodicScan, configLoaded]);

      useEffect(() => {
        if (periodicScan && intervalMin > 0) {
          const interval = setInterval(() => scanConnections(), intervalMin * 60 * 1000);
          return () => clearInterval(interval);
        }
      }, [periodicScan, intervalMin]);

      const scanConnections = async () => {
        setIsScanning(true);
        try {
          const netstatOutput = await ipcRenderer.invoke('run-netstat');
          const lines = netstatOutput.split('\n').filter(line => line.includes('ESTABLISHED'));
          const ipSet = new Set(lines.map(line => {
            const parts = line.trim().split(/\s+/);
            return parts[2]?.split(':')[0];
          }).filter(ip => ip && !/^(10\.|172\.(1[6-9]|2[0-9]|3[0-1])\.|192\.168\.|127\.|::1|0\.0\.0\.0)/.test(ip)));

          const processMap = await ipcRenderer.invoke('get-process-name');

          const connections = [];
          let requestCount = 0;
          let hasPlayedSound = false;

          for (const ip of ipSet) {
            try {
              const response = await axios.get(`http://ip-api.com/json/${ip}`);
              if (response.data.status === 'success') {
                const { country, isp, org } = response.data;
                const isRisky = bannedIPs.includes(ip) || riskyCountries.includes(country) || riskyProviders.some(p => isp.includes(p) || org.includes(p));
                const line = lines.find(l => l.includes(ip));
                const parts = line.trim().split(/\s+/);
                const pid = parts[parts.length - 1];
                const processName = processMap[pid] || 'Unknown';
                connections.push({
                  ip,
                  country,
                  isp,
                  org,
                  isRisky,
                  pid: isNaN(pid) ? 'Unknown' : pid,
                  processName
                });
                if (isRisky && !hasPlayedSound) {
                  new Audio('https://freesound.org/data/previews/316/316847_4939433-lq.mp3').play();
                  hasPlayedSound = true;
                }
              }
            } catch (error) {
              console.error(`Error checking IP ${ip}:`, error);
            }
            requestCount++;
            if (requestCount >= 45) {
              await new Promise(resolve => setTimeout(resolve, 60000));
              requestCount = 0;
            }
            await new Promise(resolve => setTimeout(resolve, 100));
          }
          setConnections(connections);
        } catch (error) {
          console.error('Error checking:', error);
        }
        setIsScanning(false);
      };

      const countryCounts = connections.reduce((acc, conn) => {
        acc[conn.country] = (acc[conn.country] || 0) + 1;
        return acc;
      }, {});

      return (
        <div className={isDarkMode ? 'dark' : 'light'}>
          <h1>{i18next.t('appTitle')}</h1>
          
          <div className="tabs">
            <div className={`tab ${activeTab === 'main' ? 'active' : ''}`} onClick={() => setActiveTab('main')}>
              Main
            </div>
            <div className={`tab ${activeTab === 'settings' ? 'active' : ''}`} onClick={() => setActiveTab('settings')}>
              Settings
            </div>
          </div>

          {activeTab === 'main' && (
            <div>
              <button onClick={scanConnections} disabled={isScanning}>
                {isScanning ? <span className="spinner"></span> : i18next.t('check')}
              </button>
              <div className="form-group" style={{ marginTop: '0.625rem' }}>
                <label>
                  <input
                    type="checkbox"
                    checked={periodicScan}
                    onChange={() => setPeriodicScan(!periodicScan)}
                  />
                  {i18next.t('periodic')}
                </label>
              </div>
              <div style={{ marginTop: '1.25rem' }}>
                <h2>{i18next.t('connectionsByCountry')}</h2>
                {Object.keys(countryCounts).length > 0 ? (
                  <table>
                    <thead>
                      <tr>
                        <th>Country</th>
                        <th>Connections</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.entries(countryCounts).map(([country, count]) => (
                        <tr key={country}>
                          <td>{country}</td>
                          <td>{count}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                ) : (
                  <p>{i18next.t('noConnections')}</p>
                )}
              </div>
              <div style={{ marginTop: '1.25rem' }}>
                <h2>Scanned IPs</h2>
                {connections.length > 0 ? (
                  <table>
                    <thead>
                      <tr>
                        <th>IP</th>
                        <th>Country</th>
                        <th>ISP</th>
                        <th>Org</th>
                        <th>PID</th>
                        <th>Process</th>
                        <th>Risky</th>
                        <th>WHOIS</th>
                      </tr>
                    </thead>
                    <tbody>
                      {connections.map(conn => (
                        <tr key={conn.ip} className={conn.isRisky ? 'risky' : ''}>
                          <td>{conn.ip}</td>
                          <td>{conn.country}</td>
                          <td>{conn.isp}</td>
                          <td>{conn.org}</td>
                          <td>{conn.pid}</td>
                          <td>{conn.processName}</td>
                          <td>{conn.isRisky ? i18next.t('riskyConnection') : '-'}</td>
                          <td>
                            <a href={`https://whois.domaintools.com/${conn.ip}`} target="_blank">WHOIS</a>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                ) : (
                  <p>{i18next.t('noConnections')}</p>
                )}
              </div>
            </div>
          )}

          {activeTab === 'settings' && (
            <div className="config">
              <div className="form-group">
                <label>Language</label>
                <select value={language} onChange={(e) => { setLanguage(e.target.value); i18next.changeLanguage(e.target.value); }}>
                  <option value="en">English</option>
                  <option value="fr">Français</option>
                  <option value="it">Italiano</option>
                  <option value="de">Deutsch</option>
                  <option value="es">Español</option>
                  <option value="el">Ελληνικά</option>
                  <option value="ru">Русский</option>
                  <option value="zh">中文</option>
                  <option value="ko">한국어</option>
                </select>
              </div>
              <div className="form-group">
                <label>{i18next.t('darkMode')}</label>
                <input type="checkbox" checked={isDarkMode} onChange={() => setIsDarkMode(!isDarkMode)} />
              </div>
              <div className="form-group">
                <label>{i18next.t('interval')}</label>
                <input
                  type="number"
                  value={intervalMin}
                  onChange={(e) => setIntervalMin(Math.max(0, parseInt(e.target.value)))}
                />
              </div>
              <div className="form-group">
                <label>{i18next.t('bannedIPs')}</label>
                <input
                  type="text"
                  value={bannedIPs.join(',')}
                  onChange={(e) => setBannedIPs(e.target.value.split(',').map(ip => ip.trim()).filter(ip => ip))}
                />
              </div>
              <div className="form-group">
                <label>{i18next.t('riskyProviders')}</label>
                <input
                  type="text"
                  value={riskyProviders.join(',')}
                  onChange={(e) => setRiskyProviders(e.target.value.split(',').map(p => p.trim()).filter(p => p))}
                />
              </div>
              <div className="form-group">
                <label>{i18next.t('countriesFriendly')}</label>
                <select multiple value={friendlyCountries} onChange={(e) => setFriendlyCountries(Array.from(e.target.selectedOptions, opt => opt.value))}>
                  {countries.map(country => <option key={country} value={country}>{country}</option>)}
                </select>
              </div>
              <div className="form-group">
                <label>{i18next.t('countriesRisky')}</label>
                <select multiple value={riskyCountries} onChange={(e) => setRiskyCountries(Array.from(e.target.selectedOptions, opt => opt.value))}>
                  {countries.map(country => <option key={country} value={country}>{country}</option>)}
                </select>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>